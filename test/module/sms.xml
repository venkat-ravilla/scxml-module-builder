<state id="sms">
  <state id="smsshorturl">
    <onentry>
      <script><![CDATA[
        short_links_url = tfs.getShortLinksAPIUrl(environment);
      ]]></script>

      <send id="id_shortlinks"
            typeexpr="send_type_http_post"
            targetexpr="short_links_url"
            tfs:fetchtimeoutexpr="DEFAULT_API_TIMEOUT"
            tfs:enctype="application/json">
        <param name="address" expr="smsMessage"/>
        <param name="useShortLinks" expr="'true'"/>
        <param name="length" expr="'8'"/>
      </send>
    </onentry>
    <transition event="error.send" cond="_event.sendid === 'id_shortlinks'">
      <log label="Short Links API Failure" expr="'GET to Short Links' + JSON.stringify(_event.data)"/>
      <script><![CDATA[
          prompt_name =  "smsshorturl_error_send";
        ]]></script>
      <!-- For present.answer, queue into actions array -->
      <assign location="href_answer" expr="tfs.getKBAPIUrl(environment, prompt_name)"/>
      <assign location="reason" expr="prompt_name"/>
      <script><![CDATA[presentAnswer(href_answer,reason);]]></script>
      <raise event="escalate"/>
    </transition>

    <transition event="send.successful" cond="_event.sendid === 'id_shortlinks'">
      <log expr="JSON.stringify(_event.data)" label="ATLOG:channel.id_shortlinks.send.successful"/>  
      <assign location="shortlinks_resp" expr="_event.data"/>
      <if cond="shortlinks_resp['short_url']" >
        <assign location="smsShortMessage" expr="shortlinks_resp['short_url']"/>
        <raise event="sendsms"/>
      <else/>
        <script><![CDATA[
            prompt_name =  "short_link_failure";
          ]]></script>
        <!-- For present.answer, queue into actions array -->
        <assign location="href_answer" expr="tfs.getKBAPIUrl(environment, prompt_name)"/>
        <assign location="reason" expr="prompt_name"/>
        <script><![CDATA[presentAnswer(href_answer,reason);]]></script>
        <raise event="escalate"/>
      </if>
    </transition>
  </state>
  <!-- end smsshorturl -->
  <transition event="sendsms" target="sendsms"/> 
  <state id="sendsms">
    <onentry>
      <script><![CDATA[
        omnichannel_orch_sms_send_url = tfs.getOmnichannelOrcSendSmsAPIUrl(environment,clientConfig);
      ]]></script>

      <send id="id_smssend"
            typeexpr="send_type_http_post"
            targetexpr="omnichannel_orch_sms_send_url"
            tfs:fetchtimeoutexpr="DEFAULT_API_TIMEOUT"
            tfs:enctype="application/json">
        <param name="phoneNumber" expr="ani"/>
        <param name="countryCode" expr="countryCode"/>
        <param name="message" expr="smsShortMessage"/>
      </send>
    </onentry>
    <transition event="error.send" cond="_event.sendid === 'id_smssend'">
      <log label="Sms send API Failure" expr="'GET to sms send' + JSON.stringify(_event.data)"/>
      <script><![CDATA[
          prompt_name =  "sendsms_error_send";
        ]]></script>
      <!-- For present.answer, queue into actions array -->
      <assign location="href_answer" expr="tfs.getKBAPIUrl(environment, prompt_name)"/>
      <assign location="reason" expr="prompt_name"/>
      <script><![CDATA[presentAnswer(href_answer,reason);]]></script>
      <raise event="escalate"/>
    </transition>

    <transition event="send.successful" cond="_event.sendid === 'id_smssend'">
      <log expr="JSON.stringify(_event.data)" label="ATLOG:channel.id_smssend.send.successful"/>
      <assign location="smssend_resp" expr="_event.data"/>
      <if cond="smssend_resp.status === 'success' &amp;&amp; smssend_resp.smsId">
        <assign location="smsId" expr="smssend_resp.smsId"/>
        <script><![CDATA[
            prompt_name =  "sms_sent";
          ]]></script>
        <!-- For present.answer, queue into actions array -->
        <assign location="href_answer" expr="tfs.getKBAPIUrl(environment, prompt_name)"/>
        <assign location="reason" expr="prompt_name"/>
        <script><![CDATA[presentAnswer(href_answer,reason);]]></script>
        <raise event="smsstatus"/>
      <else/>
        <script><![CDATA[
            prompt_name =  "sms_send_failure";
          ]]></script>
        <!-- For present.answer, queue into actions array -->
        <assign location="href_answer" expr="tfs.getKBAPIUrl(environment, prompt_name)"/>
        <assign location="reason" expr="prompt_name"/>
        <script><![CDATA[presentAnswer(href_answer,reason);]]></script>
        <raise event="escalate"/>
      </if>
    </transition>
  </state>
  <!-- end sendsms -->
  <transition event="smsstatus" target="smsstatus"/> 
  <state id="smsstatus">
    <onentry>
      <script><![CDATA[
        omnichannel_orch_sms_status_url = tfs.getOmnichannelOrcSmsStatusAPIUrl(environment,clientConfig,smsId);
        statuscount =  statuscount+1;
      ]]></script>
      <send id="id_smsstatus"
            typeexpr="send_type_http_get"
            targetexpr="omnichannel_orch_sms_status_url"
            tfs:fetchtimeoutexpr="DEFAULT_API_TIMEOUT"
            tfs:enctype="application/json">
      </send>
    </onentry>
    <transition event="error.send" cond="_event.sendid === 'id_smsstatus'">
      <log label="Sms status check API Failure" expr="'GET to Sms status check' + JSON.stringify(_event.data)"/>
      <script><![CDATA[
          prompt_name =  "smsstatus_error_send";
        ]]></script>
      <!-- For present.answer, queue into actions array -->
      <assign location="href_answer" expr="tfs.getKBAPIUrl(environment, prompt_name)"/>
      <assign location="reason" expr="prompt_name"/>
      <script><![CDATA[presentAnswer(href_answer,reason);]]></script>
      <raise event="escalate"/>
    </transition>

    <transition event="send.successful" cond="_event.sendid === 'id_smsstatus'"> 
      <log expr="JSON.stringify(_event.data)" label="ATLOG:channel.id_smsstatus.send.successful"/>
      <assign location="smsstatus_resp" expr="_event.data"/>
      <if cond="smsstatus_resp.status === 'success' &amp;&amp; smsstatus_resp.smsResponse === 'DELIVERED_TO_DEVICE'" >
        <script><![CDATA[
            prompt_name =  "sms_delivery_success";
          ]]></script>
        <!-- For present.answer, queue into actions array -->
        <assign location="href_answer" expr="tfs.getKBAPIUrl(environment, prompt_name)"/>
        <assign location="reason" expr="prompt_name"/>
        <script><![CDATA[presentAnswer(href_answer,reason);]]></script>
        <raise event="terminate"/>
      <elseif cond="statuscount < 3 &amp;&amp; smsstatus_resp.smsResponse === 'SENT_BY_PROVIDER'"/>
        <send event="smsstatus" delay="10s"/>
      <else/>
        <script><![CDATA[
            prompt_name =  "sms_delivery_failure";
          ]]></script>
        <!-- For present.answer, queue into actions array -->
        <assign location="href_answer" expr="tfs.getKBAPIUrl(environment, prompt_name)"/>
        <assign location="reason" expr="prompt_name"/>
        <script><![CDATA[presentAnswer(href_answer,reason);]]></script>
        <raise event="escalate"/>
      </if>
    </transition>
  </state>
  <!-- end smsstatus -->
</state>
<!-- end sms -->